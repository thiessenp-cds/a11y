<!doctype html>
<html lang="en">
  <head>
      <meta charset="utf-8" />
      <title>Drag and Drop</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        .listsContainer {
          display:flex
        }
        .listContainer {
          margin-right:2rem;
        }
        .draggableList {
          list-style-type: none;
          border: 2px solid black;
          border-radius: 10px;
          padding: .5rem;
        }
        .draggableList li {
          padding: 1rem;
          text-align: center;
          cursor: move;
        }
        .draggableList li div {
          height: 1rem;
          width: 8rem;
          padding: .5rem;
          border-radius: 10px;
          background-color: #ccc;
          border: 2px solid black;
        }
        .draggableList li.dragElem {
          opacity: 0.4;
        }
        .draggableList li.dragOver {
          border-top: 4px dashed green;
        }
        [draggable] {
          -moz-user-select: none;
          -khtml-user-select: none;
          -webkit-user-select: none;
          user-select: none;
        }
        /* Taken from: https://css-tricks.com/inclusively-hidden/ */
        .sr-only:not(:focus):not(:active) {
          clip: rect(0 0 0 0); 
          clip-path: inset(50%);
          height: 1px;
          overflow: hidden;
          position: absolute;
          white-space: nowrap; 
          width: 1px;
        }
      </style>
  </head>
  <body>
    <main>
      <h1>Drag and Drop</h1>
      <div class="listsContainer">
        <div class="listContainer">
          <h2 id="list1-title">List 1</h2>
          <div id="list1-description" class="sr-only">Navigate between lists using tab and arrow keys within the list. Select an item with <kbd>spacebar</kbd> and drop drop it in position with <kbd>enter"</kbd></div>
          <ul id="list1" class="draggableList" aria-labelledby="list1-title" tabindex="0" aria-describedby="list1-description">
            <li id="l1-1" draggable="true" tabindex="-1"><div>A1</div></li>
            <li id="l1-2" draggable="true" tabindex="-1"><div>B1</div></li>
            <li id="l1-3" draggable="true" tabindex="-1"><div>C1</div></li>
            <li id="l1-4" draggable="true" tabindex="-1"><div>D1</div></li>
            <li id="l1-5" draggable="true" tabindex="-1"><div>E1</div></li>
          </ul>
        </div>
        <div class="listContainer">
          <h2 id="list2-title">List 2</h2>
          <ul id="list2" class="draggableList" aria-labelledby="list2-title" tabindex="0">
            <li id="l2-1" draggable="true" tabindex="-1"><div>A2</div></li>
            <li id="l2-2" draggable="true" tabindex="-1"><div>B2</div></li>
            <li id="l2-3" draggable="true" tabindex="-1"><div>C2</div></li>
            <li id="l2-4" draggable="true" tabindex="-1"><div>D2</div></li>
            <li id="l2-5" draggable="true" tabindex="-1"><div>E2</div></li>
          </ul>
        </div>
        <div class="listContainer">
          <h2 id="list3-title">List 3</h2>
          <ul id="list3" class="draggableList" aria-labelledby="list3-title" tabindex="0">
            <li id="l3-1" draggable="true" tabindex="-1"><div>A3</div></li>
            <li id="l3-2" draggable="true" tabindex="-1"><div>B3</div></li>
            <li id="l3-3" draggable="true" tabindex="-1"><div>C3</div></li>
            <li id="l3-4" draggable="true" tabindex="-1"><div>D3</div></li>
            <li id="l3-5" draggable="true" tabindex="-1"><div>E3</div></li>
          </ul>
        </div>
      </div>
      <div id="liveChannel" aria-live="polite" aria-relevant="additions text" class="sr-only"></div>
    </main>
    <script>
      function handleDragStart(e) {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text", `${e.target.id},${e.target.parentElement.id}`); // Move by Ids
        e.target.classList.add("dragElem");
        announce(`Item selected with text ${e.target.textContent}.`);
      }

      function handleDragOver(e) {
        if (e.preventDefault) { e.preventDefault(); } // Allows drop
        e.dataTransfer.dropEffect = "move";
        e.target.classList.add("dragOver");
      }

      function handleDragEnter(e) {
        // TODO: current hover target
      }

      function handleDragLeave(e) {
        e.target.classList.remove("dragOver");
      }

      function handleDrop(e, dragData) {
        // Useful if a E.g. link to stop navigation
        if (e.dataTransfer) {
          const isLink = e.dataTransfer.types.includes("text/uri-list");
          if (isLink) { e.preventDefault(); }
        }
        // Pull data from detData API or params to get elements
        const [sourceId, parentId] = dragData ? dragData.split(",") : e.dataTransfer.getData("text").split(",");
        const sourceEl = document.getElementById(sourceId);
        const parentSourceEl = document.getElementById(parentId);
        const targetEl = e.target;
        // Stop if dragged onto self
        let droppedEl;
        if (sourceEl != targetEl) {
          parentSourceEl.removeChild(sourceEl);
          targetEl.insertAdjacentHTML("beforebegin", sourceEl.outerHTML);
          droppedEl = targetEl.previousSibling;
          droppedEl.classList.remove("dragElem");
          addDnDHandlers(droppedEl);
          announce(`Item dropped with text ${droppedEl.textContent}.`);
        }
        // Clean up
        targetEl.classList.remove("dragOver");
      }

      function handleDragEnd(e) {
        e.target.classList.remove("dragOver");
        e.target.classList.remove("dragElem");
      }

      function addDnDHandlers(elem) {
        elem.addEventListener("dragstart", handleDragStart, false);
        elem.addEventListener("dragenter", handleDragEnter, false)
        elem.addEventListener("dragover", handleDragOver, false);
        elem.addEventListener("dragleave", handleDragLeave, false);
        elem.addEventListener("drop", handleDrop, false);
        elem.addEventListener("dragend", handleDragEnd, false);
      }

      function focusNext(e, children, direction="down") {
        // const children = el.querySelectorAll(childrenSelector);
        const index = Array.from(children).indexOf(document.activeElement);
        const nextIndex = index + (direction==="down" ? 1 : -1);
        if (nextIndex < 0 || nextIndex >= children.length) {
          return;
        }
        if (children[nextIndex]) {
          children[nextIndex].focus();
        }
      }

      let dragData = null;
      function addKeyNav(el, childrenSelector) {
        el.addEventListener("keydown", function(e) {
          switch (e.key) {
            case "ArrowDown":
              focusNext(e, el.querySelectorAll(childrenSelector));
              break;
            case "ArrowUp":
              focusNext(e, el.querySelectorAll(childrenSelector), "up");
              break;
            case " ":
              dragData = `${e.target.id},${e.target.parentElement.id}`;
              e.target.classList.add("dragElem");
              announce(`Item selected with text ${e.target.textContent}.`);
              break;
            case "Enter":
              if (dragData) {
                handleDrop(e, dragData);
              }
              break;
            default:
              return;
          }

          e.preventDefault();
        });
      }

      const liveChannel = document.getElementById("liveChannel");
      function announce(message) {
        liveChannel.textContent = message;
      }

      document.addEventListener("DOMContentLoaded", function() {
        // See: 
        // https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API

        // TODO: use delegation instead?
        const list1 = document.querySelectorAll("#list1 li");
        [].forEach.call(list1, addDnDHandlers);
        const list2 = document.querySelectorAll("#list2 li");
        [].forEach.call(list2, addDnDHandlers);
        const list3 = document.querySelectorAll("#list3 li");
        [].forEach.call(list3, addDnDHandlers);

        // Adds keynav
        const list1Container = document.getElementById("list1");
        const list1ChildrenSelector = "#list1 li";
        addKeyNav(list1Container, list1ChildrenSelector);
        const list2Container = document.getElementById("list2");
        const list2ChildrenSelector = "#list2 li";
        addKeyNav(list2Container, list2ChildrenSelector);
        const list3Container = document.getElementById("list3");
        const list3ChildrenSelector = "#list3 li";
        addKeyNav(list3Container, list3ChildrenSelector);
      });
    </script>
  </body>
</html>
